{
  "name": "WF-SP-01 Inbound Lead Handler Multi-Tenant MYHOST Bizmate XXIII",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "inbound-lead-v3",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2608,
        0
      ],
      "id": "webhook",
      "name": "Webhook",
      "webhookId": "inbound-lead-v3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://jjpscimtxrudtepzwhag.supabase.co/rest/v1/rpc/find_lead_by_contact",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqcHNjaW10eHJ1ZHRlcHp3aGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDMyMzIsImV4cCI6MjA3ODUxOTIzMn0._U_HwdF5-yT8-prJLzkdO_rGbNuu7Z3gpUQW0Q8zxa0"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"p_phone\": {{ $json.phone ? '\"' + $json.phone + '\"' : 'null' }},\n  \"p_email\": {{ $json.email ? '\"' + $json.email + '\"' : 'null' }},\n  \"p_tenant_id\": \"{{ $json.tenant_id }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1936,
        0
      ],
      "id": "buscar-lead",
      "name": "Buscar Lead",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 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"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "=={\n  \"model\": \"gpt-4o-mini\",\n  \"max_tokens\": 10,\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Clasifica el mensaje en UNA palabra: info, price, availability, o booking. Responde SOLO una palabra.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"{{ $json.message.replace(/\\\\n/g, ' ').replace(/\\\"/g, '') }}\"\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1456,
        0
      ],
      "id": "clasificar",
      "name": "Clasificar"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.existing_lead_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "empty"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "New"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.existing_lead_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Existing"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -1008,
        0
      ],
      "id": "switch-lead",
      "name": "Switch Lead"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://jjpscimtxrudtepzwhag.supabase.co/rest/v1/leads",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqcHNjaW10eHJ1ZHRlcHp3aGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDMyMzIsImV4cCI6MjA3ODUxOTIzMn0._U_HwdF5-yT8-prJLzkdO_rGbNuu7Z3gpUQW0Q8zxa0"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqcHNjaW10eHJ1ZHRlcHp3aGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDMyMzIsImV4cCI6MjA3ODUxOTIzMn0._U_HwdF5-yT8-prJLzkdO_rGbNuu7Z3gpUQW0Q8zxa0"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tenant_id\": \"{{ $json.tenant_id }}\",\n  \"property_id\": \"{{ $json.property_id }}\",\n  \"name\": \"{{ $json.name }}\",\n  \"phone\": {{ $json.phone ? '\"' + $json.phone + '\"' : 'null' }},\n  \"email\": {{ $json.email ? '\"' + $json.email + '\"' : 'null' }},\n  \"channel\": \"{{ $json.channel }}\",\n  \"state\": \"{{ $json.is_hot ? 'HOT' : 'NEW' }}\",\n  \"intent\": \"{{ $json.intent }}\",\n  \"score\": {{ $json.intent_score }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -800,
        -144
      ],
      "id": "insert-lead",
      "name": "INSERT"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://jjpscimtxrudtepzwhag.supabase.co/rest/v1/leads?id=eq.{{ $json.existing_lead_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqcHNjaW10eHJ1ZHRlcHp3aGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDMyMzIsImV4cCI6MjA3ODUxOTIzMn0._U_HwdF5-yT8-prJLzkdO_rGbNuu7Z3gpUQW0Q8zxa0"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqcHNjaW10eHJ1ZHRlcHp3aGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDMyMzIsImV4cCI6MjA3ODUxOTIzMn0._U_HwdF5-yT8-prJLzkdO_rGbNuu7Z3gpUQW0Q8zxa0"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"last_contacted_at\": \"{{ new Date().toISOString() }}\",\n  \"state\": \"{{ $json.is_hot ? 'HOT' : 'ENGAGED' }}\",\n  \"intent\": \"{{ $json.intent }}\",\n  \"score\": {{ $json.intent_score }},\n  \"updated_at\": \"{{ new Date().toISOString() }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -800,
        160
      ],
      "id": "update-lead",
      "name": "UPDATE"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://jjpscimtxrudtepzwhag.supabase.co/rest/v1/lead_events",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqcHNjaW10eHJ1ZHRlcHp3aGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDMyMzIsImV4cCI6MjA3ODUxOTIzMn0._U_HwdF5-yT8-prJLzkdO_rGbNuu7Z3gpUQW0Q8zxa0"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqcHNjaW10eHJ1ZHRlcHp3aGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDMyMzIsImV4cCI6MjA3ODUxOTIzMn0._U_HwdF5-yT8-prJLzkdO_rGbNuu7Z3gpUQW0Q8zxa0"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"lead_id\": \"{{ $json[0]?.id || $json.id }}\",\n  \"event_type\": \"lead_created\",\n  \"payload_json\": {\n    \"channel\": \"{{ $('Set Intent').item.json.channel }}\",\n    \"message\": \"{{ $('Set Intent').item.json.message }}\",\n    \"intent\": \"{{ $('Set Intent').item.json.intent }}\",\n    \"score\": {{ $('Set Intent').item.json.intent_score }}\n  }\n}",
        "options": {}
      },
      "id": "log-created",
      "name": "Log Created",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -608,
        -144
      ],
      "typeVersion": 4.3
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://jjpscimtxrudtepzwhag.supabase.co/rest/v1/lead_events",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqcHNjaW10eHJ1ZHRlcHp3aGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDMyMzIsImV4cCI6MjA3ODUxOTIzMn0._U_HwdF5-yT8-prJLzkdO_rGbNuu7Z3gpUQW0Q8zxa0"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqcHNjaW10eHJ1ZHRlcHp3aGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDMyMzIsImV4cCI6MjA3ODUxOTIzMn0._U_HwdF5-yT8-prJLzkdO_rGbNuu7Z3gpUQW0Q8zxa0"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"lead_id\": \"{{ $json[0]?.id || $json.id }}\",\n  \"event_type\": \"message_received\",\n  \"payload_json\": {\n    \"channel\": \"{{ $('Set Intent').item.json.channel }}\",\n    \"message\": \"{{ $('Set Intent').item.json.message }}\",\n    \"intent\": \"{{ $('Set Intent').item.json.intent }}\",\n    \"score\": {{ $('Set Intent').item.json.intent_score }}\n  }\n}",
        "options": {}
      },
      "id": "log-received",
      "name": "Log Received",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -608,
        160
      ],
      "typeVersion": 4.3
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "loose"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $('Set Intent').item.json.channel }}",
                    "rightValue": "whatsapp"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "WhatsApp"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "loose"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "leftValue": "={{ $('Set Intent').item.json.channel }}",
                    "rightValue": "whatsapp"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Other"
            }
          ]
        },
        "options": {}
      },
      "id": "switch-canal",
      "name": "Switch Canal",
      "type": "n8n-nodes-base.switch",
      "position": [
        -400,
        0
      ],
      "typeVersion": 3.3
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"lead_id\": \"{{ $json[0]?.id || $json.id || 'unknown' }}\",\n  \"message\": \"Lead processed\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        208,
        -16
      ],
      "id": "respond",
      "name": "Respond"
    },
    {
      "parameters": {
        "jsCode": "// Validate Master Event v1.0\nconst e = $json.body || $json;\n\n// Validation\nif (!e.schema_version || e.schema_version !== '1.0') {\n  throw new Error('Invalid schema_version');\n}\nif (!e.tenant || !e.tenant.tenant_id) {\n  throw new Error('Missing tenant.tenant_id');\n}\nif (!e.contact || !e.contact.phone) {\n  throw new Error('Missing contact.phone');\n}\nif (!e.message || !e.message.text) {\n  throw new Error('Missing message.text');\n}\n\n// Extract and normalize for rest of flow\nreturn [{\n  json: {\n    // From Master Event\n    schema_version: e.schema_version,\n    event_id: e.event_id,\n    source: e.source,\n    \n    // Tenant info (already provided)\n    tenant_id: e.tenant.tenant_id,\n    property_id: e.tenant.property_id || '18711359-1378-4d12-9ea6-fb31c0b1bac2',\n    \n    // Contact info\n    name: e.contact.name || 'Unknown',\n    phone: e.contact.phone,\n    email: e.contact.email || null,\n    language: e.contact.language || 'en',\n    \n    // Message info\n    channel: e.message.channel || e.source || 'web',\n    message: e.message.text,\n    message_id: e.message.message_id || null,\n    \n    // Context (optional booking info)\n    check_in: e.context?.checkin || null,\n    check_out: e.context?.checkout || null,\n    guests: e.context?.guests || null,\n    intent_hint: e.context?.intent || null,\n    \n    // Meta\n    flow_origin: e.meta?.flow_origin || 'unknown',\n    trace_id: e.meta?.trace_id || null,\n    \n    // Raw for logging\n    raw_payload: JSON.stringify(e)\n  }\n}];"
      },
      "id": "18df08be-2561-4585-afad-23aba4e60fe1",
      "name": "Validate Master Event",
      "type": "n8n-nodes-base.code",
      "position": [
        -2272,
        0
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "existing_lead_id",
              "name": "existing_lead_id",
              "value": "={{ $json.id || '' }}",
              "type": "string"
            },
            {
              "id": "existing_lead_state",
              "name": "existing_lead_state",
              "value": "={{ $json.state || '' }}",
              "type": "string"
            },
            {
              "id": "tenant_id",
              "name": "tenant_id",
              "value": "={{ $('Validate Master Event').item.json.tenant_id }}",
              "type": "string"
            },
            {
              "id": "property_id",
              "name": "property_id",
              "value": "={{ $('Validate Master Event').item.json.property_id }}",
              "type": "string"
            },
            {
              "id": "channel",
              "name": "channel",
              "value": "={{ $('Validate Master Event').item.json.channel }}",
              "type": "string"
            },
            {
              "id": "name",
              "name": "name",
              "value": "={{ $('Validate Master Event').item.json.name }}",
              "type": "string"
            },
            {
              "id": "email",
              "name": "email",
              "value": "={{ $('Validate Master Event').item.json.email }}",
              "type": "string"
            },
            {
              "id": "phone",
              "name": "phone",
              "value": "={{ $('Validate Master Event').item.json.phone }}",
              "type": "string"
            },
            {
              "id": "message",
              "name": "message",
              "value": "={{ $('Validate Master Event').item.json.message }}",
              "type": "string"
            },
            {
              "id": "check_in",
              "name": "check_in",
              "value": "={{ $('Validate Master Event').item.json.check_in }}",
              "type": "string"
            },
            {
              "id": "check_out",
              "name": "check_out",
              "value": "={{ $('Validate Master Event').item.json.check_out }}",
              "type": "string"
            },
            {
              "id": "guests",
              "name": "guests",
              "value": "={{ $('Validate Master Event').item.json.guests }}",
              "type": "number"
            },
            {
              "id": "language",
              "name": "language",
              "value": "={{ $('Validate Master Event').item.json.language }}",
              "type": "string"
            },
            {
              "id": "source",
              "name": "source",
              "value": "={{ $('Validate Master Event').item.json.source }}",
              "type": "string"
            },
            {
              "id": "flow_origin",
              "name": "flow_origin",
              "value": "={{ $('Validate Master Event').item.json.flow_origin }}",
              "type": "string"
            },
            {
              "id": "raw_payload",
              "name": "raw_payload",
              "value": "={{ $('Validate Master Event').item.json.raw_payload }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "22ce06d2-09e8-48c5-a911-d4f22a94271b",
      "name": "Merge",
      "type": "n8n-nodes-base.set",
      "position": [
        -1712,
        0
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "intent",
              "name": "intent",
              "type": "string",
              "value": "={{ $json.choices[0].message.content.trim().toLowerCase() }}"
            },
            {
              "id": "intent_score",
              "name": "intent_score",
              "type": "number",
              "value": "={{ {'info': 10, 'price': 20, 'availability': 30, 'booking': 50}[$json.choices[0].message.content.trim().toLowerCase()] || 10 }}"
            },
            {
              "id": "is_hot",
              "name": "is_hot",
              "type": "boolean",
              "value": "={{ $json.choices[0].message.content.trim().toLowerCase() === 'booking' }}"
            },
            {
              "id": "existing_lead_id",
              "name": "existing_lead_id",
              "type": "string",
              "value": "={{ $('Merge').item.json.existing_lead_id }}"
            },
            {
              "id": "existing_lead_state",
              "name": "existing_lead_state",
              "type": "string",
              "value": "={{ $('Merge').item.json.existing_lead_state }}"
            },
            {
              "id": "tenant_id",
              "name": "tenant_id",
              "type": "string",
              "value": "={{ $('Merge').item.json.tenant_id }}"
            },
            {
              "id": "property_id",
              "name": "property_id",
              "type": "string",
              "value": "={{ $('Merge').item.json.property_id }}"
            },
            {
              "id": "channel",
              "name": "channel",
              "type": "string",
              "value": "={{ $('Merge').item.json.channel }}"
            },
            {
              "id": "name",
              "name": "name",
              "type": "string",
              "value": "={{ $('Merge').item.json.name }}"
            },
            {
              "id": "email",
              "name": "email",
              "type": "string",
              "value": "={{ $('Merge').item.json.email }}"
            },
            {
              "id": "phone",
              "name": "phone",
              "type": "string",
              "value": "={{ $('Merge').item.json.phone }}"
            },
            {
              "id": "message",
              "name": "message",
              "type": "string",
              "value": "={{ $('Merge').item.json.message }}"
            },
            {
              "id": "check_in",
              "name": "check_in",
              "type": "string",
              "value": "={{ $('Merge').item.json.check_in }}"
            },
            {
              "id": "check_out",
              "name": "check_out",
              "type": "string",
              "value": "={{ $('Merge').item.json.check_out }}"
            },
            {
              "id": "guests",
              "name": "guests",
              "type": "number",
              "value": "={{ $('Merge').item.json.guests }}"
            },
            {
              "id": "language",
              "name": "language",
              "type": "string",
              "value": "={{ $('Merge').item.json.language }}"
            },
            {
              "id": "source",
              "name": "source",
              "type": "string",
              "value": "={{ $('Merge').item.json.source }}"
            },
            {
              "id": "flow_origin",
              "name": "flow_origin",
              "type": "string",
              "value": "={{ $('Merge').item.json.flow_origin }}"
            }
          ]
        },
        "options": {}
      },
      "id": "ae4ca247-45f0-4707-9d6b-c66e600c3fb7",
      "name": "Set Intent1",
      "type": "n8n-nodes-base.set",
      "position": [
        -1248,
        0
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "intent",
              "name": "intent",
              "type": "string",
              "value": "={{ $json.choices[0].message.content.trim().toLowerCase() }}"
            },
            {
              "id": "intent_score",
              "name": "intent_score",
              "type": "number",
              "value": "={{ {'info': 10, 'price': 20, 'availability': 30, 'booking': 50}[$json.choices[0].message.content.trim().toLowerCase()] || 10 }}"
            },
            {
              "id": "is_hot",
              "name": "is_hot",
              "type": "boolean",
              "value": "={{ $json.choices[0].message.content.trim().toLowerCase() === 'booking' }}"
            },
            {
              "id": "existing_lead_id",
              "name": "existing_lead_id",
              "type": "string",
              "value": "={{ $('Merge').item.json.existing_lead_id }}"
            },
            {
              "id": "existing_lead_state",
              "name": "existing_lead_state",
              "type": "string",
              "value": "={{ $('Merge').item.json.existing_lead_state }}"
            },
            {
              "id": "tenant_id",
              "name": "tenant_id",
              "type": "string",
              "value": "={{ $('Merge').item.json.tenant_id }}"
            },
            {
              "id": "property_id",
              "name": "property_id",
              "type": "string",
              "value": "={{ $('Merge').item.json.property_id }}"
            },
            {
              "id": "channel",
              "name": "channel",
              "type": "string",
              "value": "={{ $('Merge').item.json.channel }}"
            },
            {
              "id": "name",
              "name": "name",
              "type": "string",
              "value": "={{ $('Merge').item.json.name }}"
            },
            {
              "id": "email",
              "name": "email",
              "type": "string",
              "value": "={{ $('Merge').item.json.email }}"
            },
            {
              "id": "phone",
              "name": "phone",
              "type": "string",
              "value": "={{ $('Merge').item.json.phone }}"
            },
            {
              "id": "message",
              "name": "message",
              "type": "string",
              "value": "={{ $('Merge').item.json.message }}"
            },
            {
              "id": "check_in",
              "name": "check_in",
              "type": "string",
              "value": "={{ $('Merge').item.json.check_in }}"
            },
            {
              "id": "check_out",
              "name": "check_out",
              "type": "string",
              "value": "={{ $('Merge').item.json.check_out }}"
            },
            {
              "id": "guests",
              "name": "guests",
              "type": "number",
              "value": "={{ $('Merge').item.json.guests }}"
            },
            {
              "id": "language",
              "name": "language",
              "type": "string",
              "value": "={{ $('Merge').item.json.language }}"
            },
            {
              "id": "source",
              "name": "source",
              "type": "string",
              "value": "={{ $('Merge').item.json.source }}"
            },
            {
              "id": "flow_origin",
              "name": "flow_origin",
              "type": "string",
              "value": "={{ $('Merge').item.json.flow_origin }}"
            }
          ]
        },
        "options": {}
      },
      "id": "19e2b817-0d00-4bb4-b260-1bfcf7389e4e",
      "name": "Set Intent",
      "type": "n8n-nodes-base.set",
      "position": [
        -240,
        176
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.sendgrid.com/v3/mail/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 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"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"personalizations\": [{\"to\": [{\"email\": \"{{ $('Set Intent').item.json.email }}\"}]}],\n  \"from\": {\"email\": \"josecarrallodelafuente@gmail.com\", \"name\": \"Izumi Hotel\"},\n  \"subject\": \"Gracias por contactar Izumi Hotel üå∫\",\n  \"content\": [{\"type\": \"text/plain\", \"value\": \"Hola {{ $('Set Intent').item.json.name }},\\n\\nGracias por tu inter√©s en Izumi Hotel.\\n\\nHemos recibido tu mensaje y nuestro equipo te contactar√° pronto.\\n\\nSi tienes alguna pregunta, responde a este email o escr√≠benos por WhatsApp al +6281325764867.\\n\\nSaludos,\\nEl equipo de Izumi Hotel\"}]}",
        "options": {}
      },
      "id": "dd324473-320f-4244-8687-44bb80d437aa",
      "name": "Email",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -16,
        176
      ],
      "typeVersion": 4.3
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Validate Master Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Lead": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clasificar": {
      "main": [
        [
          {
            "node": "Set Intent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Lead": {
      "main": [
        [
          {
            "node": "INSERT",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "UPDATE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "INSERT": {
      "main": [
        [
          {
            "node": "Log Created",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "UPDATE": {
      "main": [
        [
          {
            "node": "Log Received",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Created": {
      "main": [
        [
          {
            "node": "Switch Canal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Received": {
      "main": [
        [
          {
            "node": "Switch Canal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Canal": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Intent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Master Event": {
      "main": [
        [
          {
            "node": "Buscar Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Clasificar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Intent1": {
      "main": [
        [
          {
            "node": "Switch Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Intent": {
      "main": [
        [
          {
            "node": "Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "721c6c9e-7260-4da5-87cd-9609f5735173",
  "meta": {
    "instanceId": "ca7bc7f182c365457ea4a94a4dc2efe81c23590ab8904858ce5cabfbdd56e40f"
  },
  "id": "CBiOKCQ7eGnTJXQd",
  "tags": []
}