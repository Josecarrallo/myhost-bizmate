üì¶ DOCUMENTO 2 ‚Äî CLAUDE AI (n8n)
PROYECTO: MY HOST BizMate
M√ìDULO: AUTOPILOT
FASE: 1 ‚Äî DAILY
ALCANCE: DETALLE T√âCNICO NODO A NODO (n8n)
REGLA CR√çTICA: IMPLEMENTAR TAL CUAL ¬∑ SIN A√ëADIDOS ¬∑ SIN OPTIMIZACIONES PREMATURAS

========================================================
WF-D1 ‚Äî ALWAYS-ON INQUIRIES
========================================================
OBJETIVO:
Responder mensajes 24/7, capturar leads y dar sensaci√≥n de presencia inmediata.

TRIGGER:
Webhook (POST)
Endpoint: /autopilot/inquiry

INPUT ESPERADO:
{
  tenant_id,
  property_id,
  channel,            // whatsapp | instagram | web
  contact_name,
  contact_phone,
  message_text,
  timestamp
}

NODOS (LINEAL):

NODO 1 ‚Äî Webhook Trigger
- M√©todo: POST
- Recibe JSON de entrada

NODO 2 ‚Äî Validate & Normalize
- Tipo: Set / IF
- Validar tenant_id y property_id
- Normalizar message_text
- Si falta alg√∫n campo ‚Üí aplicar default, NO fallar

NODO 3 ‚Äî Lead Upsert (Supabase)
- Buscar lead por contact_phone + property_id
- Si existe ‚Üí update last_message + updated_at
- Si no existe ‚Üí create lead
- Estado inicial: new

NODO 4 ‚Äî Intent Detection (RULE-BASED)
- NO usar IA aqu√≠
- Keywords simples:
  booking / availability / price / dates
- Clasificar:
  booking_intent | info | other

NODO 5 ‚Äî Auto Reply (Template)
- Canal: mismo que entrada
- Mensaje humano y corto
- Idioma simple (si se puede detectar)
Ejemplo:
‚ÄúThanks for your message! We‚Äôve received it and will get back to you shortly. Could you please share your dates and number of guests?‚Äù

NODO 6 ‚Äî Emit Internal Event (Set)
- Si intent = booking_intent
- Crear payload:
  { event: "booking_intent", lead_id }

NODO 7 ‚Äî Log Activity (Supabase)
- autopilot_activity = inquiry_handled
- Guardar timestamp

NODO 8 ‚Äî Respond to Webhook
- Status 200
- Body: { success: true }

========================================================
WF-D2 ‚Äî PAYMENT PROTECTION
========================================================
OBJETIVO:
Evitar reservas sin pagar, reducir presi√≥n del owner y liberar fechas autom√°ticamente.

TRIGGER:
Webhook interno o app
Endpoint: /autopilot/payment/start

INPUT:
{
  tenant_id,
  property_id,
  booking_id,
  guest_contact,
  amount,
  currency
}

REGLAS:
- HOLD_DURATION_HOURS = 24
- REMINDER_1 = +6h
- REMINDER_2 = +20h

NODOS:

NODO 1 ‚Äî Webhook Trigger

NODO 2 ‚Äî Load Booking (Supabase)
- Fetch booking por booking_id

NODO 3 ‚Äî Update Booking Status
- status = pending_payment
- expiry_at = now + HOLD_DURATION

NODO 4 ‚Äî Send Payment Instructions
- Canal: WhatsApp / Email
- Incluir:
  - amount
  - currency
  - instrucciones
  - deadline claro

NODO 5 ‚Äî Wait Node (6h)
- Si payment_received = false ‚Üí continuar

NODO 6 ‚Äî Reminder #1
- Mensaje amable recordatorio

NODO 7 ‚Äî Wait Node (14h adicionales)
- Total 20h desde inicio

NODO 8 ‚Äî Reminder #2
- Mensaje claro de expiraci√≥n pr√≥xima

NODO 9 ‚Äî Final Check
IF payment_received:
  - status = confirmed
  - notify guest + owner
ELSE:
  - status = expired
  - release dates
  - notify guest + owner

NODO 10 ‚Äî Log Actions (Supabase)

========================================================
WF-D3 ‚Äî DAILY OWNER SUMMARY
========================================================
OBJETIVO:
Dar claridad diaria sin que el owner piense.

TRIGGER:
Cron Daily (ej. 18:00 local)

NODOS:

NODO 1 ‚Äî Cron Trigger

NODO 2 ‚Äî Query Daily Metrics (Supabase)
- new_inquiries_today
- pending_payments
- confirmed_bookings_today
- checkins_today
- expired_holds_today

NODO 3 ‚Äî Build Summary JSON
{
  date,
  metrics: { ... },
  alerts: [ ... ]
}

NODO 4 ‚Äî Save daily_summary (Supabase)
- Vinculado a tenant_id + property_id

NODO 5 ‚Äî Optional Notification
- WhatsApp message al owner (resumen corto)

NODO 6 ‚Äî Log Completion

========================================================
WF-D4 ‚Äî REVIEW / ISSUE WATCH (OPCIONAL)
========================================================
OBJETIVO:
Detectar problemas temprano.

TRIGGER:
Cron Daily o input manual desde app

NODOS:
1. Trigger
2. Check new issues / reviews
3. IF negative:
   - create alert
   - notify owner
4. Log

========================================================
REGLAS FINALES (OBLIGATORIAS)
========================================================
- No mezclar workflows
- No a√±adir l√≥gica no descrita
- No optimizar antes de validar
- Guardar siempre estado en Supabase
- Autopilot DAILY debe funcionar solo

========================================================
FIN DEL DOCUMENTO 2
ESTE DOCUMENTO ES PARA EJECUTAR, NO INTERPRETAR
========================================================